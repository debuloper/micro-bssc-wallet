<!doctype html>
<html lang="ja" class="h-full bg-[#0b0b10] text-zinc-100">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>micro-bssc-wallet — Phantom style (EVM/BNB on BSSC)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --ph-purple:#6d28d9;     /* Phantom 寄せの紫 */
      --ph-indigo:#4f46e5;
      --surface:#0f1016;
      --stroke:rgba(255,255,255,.06);
    }
    .shell{ max-width: 1100px; margin: 0 auto; padding: 32px 16px }
    .card{ background: linear-gradient(180deg,#10111a,#0b0b10 65%);
           border-radius: 16px; padding: 20px;
           box-shadow: 0 12px 32px rgba(0,0,0,.4);
           border: 1px solid var(--stroke); }
    .primary{
      background-image: linear-gradient(135deg,var(--ph-purple),var(--ph-indigo));
      color: #fff; border-radius: 12px; padding: 10px 16px; font-weight: 700;
      box-shadow: 0 8px 24px rgba(109,40,217,.35);
      transition: .12s ease; border: 1px solid rgba(255,255,255,.1);
    }
    .primary:hover{ filter: brightness(1.12); transform: translateY(-1px) }
    .primary:active{ transform: translateY(0) scale(.98) }
    .ghost{
      background: #ffffff0f; color: #e5e7eb; border-radius: 12px; padding: 10px 16px;
      border: 1px solid rgba(255,255,255,.1); transition: .12s ease;
    }
    .ghost:hover{ background:#ffffff1c }
    .ghost:active{ transform: scale(.98) }
    .field{ width:100%; background:#0f1117; color:#e5e7eb;
            border:1px solid var(--stroke); border-radius:12px; padding:10px 12px; outline:none }
    .field::placeholder{ color:#9ca3af }
    .mono{ font-variant-numeric: tabular-nums }
    .divider{ height:1px; background:linear-gradient(90deg,transparent,#ffffff12,transparent); margin:10px 0 }
    .pill{ display:inline-flex; align-items:center; gap:8px; border-radius:9999px; padding:6px 12px; font-weight:600; }
    .pill.ok  { background:rgba(34,197,94,.12); color:#86efac; border:1px solid rgba(34,197,94,.28) }
    .pill.slow{ background:rgba(245,158,11,.12); color:#fbbf24; border:1px solid rgba(245,158,11,.28) }
    .pill.err { background:rgba(244,63,94,.12);  color:#fca5a5; border:1px solid rgba(244,63,94,.28) }

    /* Phantom っぽい “白チップ”（濃い文字） */
    .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px;
           border-radius:9999px; background:#fff; color:#0b0b10; border:1px solid #e5e7eb; font-weight:600 }

    /* ログ（行カード） */
    .log-row{ display:grid; grid-template-columns: 110px minmax(0,1fr) auto;
              align-items:center; gap:12px; padding:10px 12px; border-radius:12px;
              background:#10111a; border:1px solid var(--stroke) }
    .tag{ font-size:11px; padding:2px 8px; border-radius:9999px; font-weight:700 }
    .tag.info{ background:#2a2e6b; color:#c7d2fe }
    .tag.ok  { background:#0a3c2f; color:#a7f3d0 }
    .tag.err { background:#5f1b1b; color:#fecaca }
    .hover-copy{ cursor:pointer; text-decoration: underline; text-decoration-style:dotted }

    /* トースト（白地×黒字で可読） */
    .toast{ position:fixed; right:18px; top:18px; z-index:50; display:none }
    .toast.show{ display:block; animation:fadein .15s ease-out }
    @keyframes fadein{ from{opacity:0; transform:translateY(-6px)} to{opacity:1; transform:none} }
  </style>
</head>
<body>
  <main class="shell space-y-6">
    <!-- ヘッダー -->
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl ring-1 ring-white/10"
             style="background:radial-gradient(110% 110% at top left,rgba(109,40,217,.9),rgba(79,70,229,.9)); box-shadow:0 6px 26px rgba(109,40,217,.4)"></div>
        <h1 class="text-xl md:text-2xl font-semibold tracking-tight">micro-bssc-wallet</h1>
        <span class="chip">EVM / BNB on BSSC</span>
      </div>
      <div id="statusPill" class="pill err" style="display:none">
        <span class="w-2 h-2 rounded-full bg-rose-400"></span><span id="statusText">ERROR</span>
      </div>
    </header>

    <!-- ネットワーク & クイック -->
    <section class="grid md:grid-cols-3 gap-4">
      <div class="card md:col-span-2">
        <div class="text-xs uppercase text-zinc-400 tracking-wider mb-2">Network</div>
        <div class="flex gap-2">
          <input id="rpc" class="field" placeholder="https://bssc-rpc.bssc.live"/>
          <button id="ping" class="ghost">Ping</button>
        </div>
        <div class="divider"></div>
        <div class="grid grid-cols-3 gap-4">
          <div>
            <div class="text-xs uppercase text-zinc-400 tracking-wider">Balance</div>
            <div id="bal" class="text-2xl font-semibold mono mt-1">—</div>
          </div>
          <div>
            <div class="text-xs uppercase text-zinc-400 tracking-wider">Gas price</div>
            <div id="gas" class="text-2xl font-semibold mono mt-1">—</div>
          </div>
          <div>
            <div class="text-xs uppercase text-zinc-400 tracking-wider">Last update</div>
            <div id="upd" class="mt-1 text-zinc-300">—</div>
          </div>
        </div>
      </div>

      <div class="card space-y-3">
        <div class="text-xs uppercase text-zinc-400 tracking-wider">Quick Actions</div>
        <div class="flex flex-wrap gap-2">
          <button id="gen" class="primary">Generate</button>
          <button id="save" class="ghost">Save (local)</button>
          <button id="load" class="ghost">Load</button>
          <button id="check" class="ghost">Check Balance</button>
        </div>
      </div>
    </section>

    <!-- ウォレット & 送金 -->
    <section class="grid md:grid-cols-2 gap-4">
      <div class="card space-y-3">
        <div class="text-xs uppercase text-zinc-400 tracking-wider">Your Wallet</div>
        <div class="flex items-center justify-between">
          <div id="addr" class="truncate mono">—</div>
          <div class="flex gap-2">
            <button id="copyAddr" class="ghost">Copy</button>
            <a id="expl" class="ghost" target="_blank" rel="noreferrer">Explorer</a>
          </div>
        </div>
        <div class="text-xs uppercase text-zinc-400 tracking-wider mt-2">Private Key (demo)</div>
        <textarea id="pk" rows="3" class="field"
          placeholder="※デモ用：本番は必ず暗号化保存してください"></textarea>
      </div>

      <div class="card space-y-3">
        <div class="text-xs uppercase text-zinc-400 tracking-wider">Send BNB</div>
        <input id="to"  class="field" placeholder="Recipient (0x… EVM address)"/>
        <div class="flex gap-2">
          <input id="amt" class="field" placeholder="Amount (BNB)"/>
          <button id="send" class="primary">Send</button>
        </div>
        <p class="text-sm text-zinc-500">* テスト送金には testnet BNB が必要です。</p>
      </div>
    </section>

    <!-- Activity -->
    <section class="card space-y-3">
      <div class="flex items-center justify-between">
        <div class="text-xs uppercase text-zinc-400 tracking-wider">Activity</div>
        <button id="clear" class="ghost">Clear</button>
      </div>
      <div id="logs" class="space-y-2"></div>
    </section>
  </main>

  <!-- Toast（白背景＋黒文字で視認性◎） -->
  <div id="toast" class="toast">
    <div class="rounded-xl px-3 py-2 bg-white text-black shadow-xl ring-1 ring-black/10 flex items-center gap-2">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 9v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="#10b981" stroke-width="2" stroke-linecap="round"/></svg>
      <span id="toastText" class="text-sm font-semibold">Copied</span>
    </div>
  </div>

  <!-- Web3.js v4（MetaMask不要, 署名→送信） -->
  <script src="https://cdn.jsdelivr.net/npm/web3@4.7.0/dist/web3.min.js"></script>
  <script>
    const $ = (id)=>document.getElementById(id);

    // DOM
    const rpc = $("rpc"), ping=$("ping"), gen=$("gen"), save=$("save"), load=$("load"), check=$("check");
    const addr=$("addr"), pk=$("pk"), copyAddr=$("copyAddr"), expl=$("expl");
    const bal=$("bal"), gas=$("gas"), upd=$("upd");
    const to=$("to"), amt=$("amt"), sendBtn=$("send");
    const logs=$("logs"), clearBtn=$("clear");
    const statusPill=$("statusPill"), statusText=$("statusText");
    const toast=$("toast"), toastText=$("toastText");

    // 状態
    const LS_KEY="micro_bssc_wallet_priv";
    let web3=null;               // Web3 インスタンス
    let account=null;            // { address, privateKey }

    // Helpers
    function showToast(t){ toastText.textContent=t; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"),1300); }
    function setStatus(state){ // ok/slow/err
      statusPill.style.display="inline-flex";
      statusPill.className = "pill " + (state==="ok"?"ok":state==="slow"?"slow":"err");
      const dot = state==="ok"?"bg-emerald-400":state==="slow"?"bg-amber-400":"bg-rose-400";
      statusPill.innerHTML = `<span class="w-2 h-2 rounded-full ${dot}"></span><span id="statusText">${state.toUpperCase()}</span>`;
    }
    function addLog({type="info", msg, hash}){
      const row=document.createElement("div"); row.className="log-row";
      const ts=document.createElement("div"); ts.className="mono text-zinc-400"; ts.textContent=new Date().toLocaleTimeString();
      const body=document.createElement("div"); body.className="truncate";
      const tag=document.createElement("span"); tag.className="tag "+(type==="ok"?"ok":type==="err"?"err":"info"); tag.textContent=type.toUpperCase();
      body.appendChild(tag);
      const span=document.createElement("span"); span.className="ml-2";
      if(hash){
        const a=document.createElement("a"); a.className="hover-copy";
        a.href="https://explorer.bssc.live/tx/"+hash; a.target="_blank"; a.rel="noreferrer";
        a.textContent=hash.slice(0,10)+"…"+hash.slice(-8);
        body.appendChild(a);
        const copy=document.createElement("button"); copy.className="ml-2 text-xs hover-copy text-zinc-300";
        copy.textContent="Copy"; copy.onclick=()=>{ navigator.clipboard.writeText(hash); showToast("Tx hash copied"); };
        body.appendChild(copy);
      }else{ span.textContent=msg; body.appendChild(span); }
      const tail=document.createElement("div");
      row.appendChild(ts); row.appendChild(body); row.appendChild(tail);
      logs.prepend(row);
    }
    function ensureWeb3(){
      const url=(rpc.value||"").trim(); if(!url) throw new Error("RPC URL を入力してください");
      web3 = new Web3(new Web3.providers.HttpProvider(url));
      return web3;
    }

    // ウォレット生成/保存/復元
    gen.onclick = ()=>{
      const w = Web3.eth.accounts.create(); // { address, privateKey }
      account = w;
      addr.textContent = w.address;
      pk.value = w.privateKey; // デモ保存（本番は暗号化）
      expl.href = "https://explorer.bssc.live/address/"+w.address;
      addLog({type:"info", msg:"新しいウォレットを生成しました"});
    };
    save.onclick = ()=>{
      if(!account) return addLog({type:"err", msg:"先にウォレットを生成してください"});
      localStorage.setItem(LS_KEY, account.privateKey);
      addLog({type:"ok", msg:"ローカルに秘密鍵を保存しました（デモ）"});
    };
    load.onclick = ()=>{
      const priv = localStorage.getItem(LS_KEY);
      if(!priv) return addLog({type:"err", msg:"保存された秘密鍵がありません"});
      try{
        account = Web3.eth.accounts.privateKeyToAccount(priv);
        addr.textContent = account.address; pk.value = priv;
        expl.href = "https://explorer.bssc.live/address/"+account.address;
        addLog({type:"ok", msg:"ローカルからウォレットを復元しました"});
      }catch(e){ addLog({type:"err", msg:"復元エラー: "+(e.message||e)}) }
    };
    copyAddr.onclick = async ()=>{
      const a=addr.textContent.trim(); if(!a || a==="—") return;
      await navigator.clipboard.writeText(a); showToast("Address copied");
    };

    // Ping（eth_* を直叩き）
    ping.onclick = async ()=>{
      try{
        ensureWeb3();
        const t0 = performance.now();
        const block = await web3.eth.getBlockNumber();     // eth_blockNumber
        const gasWei = await web3.eth.getGasPrice();       // eth_gasPrice
        const ms = Math.round(performance.now() - t0);

        gas.textContent = (Number(gasWei)/1e9).toFixed(3) + " gwei";
        upd.textContent = new Date().toLocaleTimeString();
        setStatus(ms<800?"ok":ms<1500?"slow":"err");
        addLog({type:"info", msg:`Ping OK (block ${block}, ${ms}ms)`});
      }catch(e){
        setStatus("err");
        addLog({type:"err", msg:"Ping失敗: "+(e.message||e)});
      }
    };

    // 残高
    check.onclick = async ()=>{
      try{
        ensureWeb3();
        if(!account) return addLog({type:"err", msg:"先にウォレットを生成/復元してください"});
        const wei = await web3.eth.getBalance(account.address);  // eth_getBalance
        bal.textContent = (Number(wei)/1e18) + " BNB";
        upd.textContent = new Date().toLocaleTimeString();
        addLog({type:"info", msg:`残高 ${wei} wei`});
      }catch(e){
        addLog({type:"err", msg:"残高取得エラー: "+(e.message||e)});
      }
    };

    // 送金（ローカル署名 → ブロードキャスト）
    sendBtn.onclick = async ()=>{
      try{
        ensureWeb3();
        if(!account) return addLog({type:"err", msg:"先にウォレットを生成/復元してください"});

        const toAddr = (to.value||"").trim();
        const amount = (amt.value||"").trim();
        if(!web3.utils.isAddress(toAddr)) return addLog({type:"err", msg:"送金先が不正です"});
        if(!amount) return addLog({type:"err", msg:"金額を入力してください"});

        const nonce    = await web3.eth.getTransactionCount(account.address, "latest");
        const gasPrice = await web3.eth.getGasPrice();
        const tx = {
          from:  account.address,
          to:    toAddr,
          value: web3.utils.toWei(amount, "ether"),
          gas:   21000,
          gasPrice,
          nonce,
          chainId: 0x4253    // BSSC Testnet
        };

        const signed   = await web3.eth.accounts.signTransaction(tx, account.privateKey);
        const receiptP = new Promise((resolve, reject)=>{
          web3.eth.sendSignedTransaction(signed.rawTransaction)
            .on("transactionHash", (hash)=> addLog({type:"info", msg:"送金送信", hash}))
            .on("receipt", (rc)=> resolve(rc))
            .on("error", (err)=> reject(err));
        });
        const rc = await receiptP;
        addLog({type: rc.status ? "ok" : "err", msg:"送金完了", hash: rc.transactionHash});
        check.click();
      }catch(e){
        addLog({type:"err", msg:"送金エラー: "+(e.message||e)});
      }
    };

    // クリア
    $("clear").onclick = ()=>{ logs.innerHTML=""; };

    // 既定 RPC
    rpc.value = "https://bssc-rpc.bssc.live";
  </script>
</body>
</html>

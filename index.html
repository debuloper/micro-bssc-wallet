sendBtn.onclick = async () => {
  try {
    // --- ensure provider ---
    const url = (rpc.value || "").trim() || "https://bssc-rpc.bssc.live";
    if (!web3 || !web3.currentProvider) {
      web3 = new Web3(new Web3.providers.HttpProvider(url));
      addLog({type:"info", msg:"Provider initialized"});
    }

    if (!account)
      return addLog({type:"err", msg:"Generate or Load a wallet first"});

    const toAddr = (to.value || "").trim();
    const amount = (amt.value || "").trim();
    if (!web3.utils.isAddress(toAddr))
      return addLog({type:"err", msg:"Invalid recipient"});
    if (!amount)
      return addLog({type:"err", msg:"Enter amount"});

    // --- get chain data ---
    const nonce = await web3.eth.getTransactionCount(account.address, "latest");
    let gasPrice;
    try { gasPrice = await web3.eth.getGasPrice(); }
    catch { gasPrice = web3.utils.toWei("1", "gwei"); }

    const tx = {
      from: account.address,
      to: toAddr,
      value: web3.utils.toWei(amount, "ether"),
      gas: 21000,
      gasPrice,
      nonce,
      chainId: 0x4253,
    };

    // --- local signing ---
    const signed = await web3Local.eth.accounts.signTransaction(tx, account.privateKey);

    // --- rebind provider (important) ---
    if (!web3.eth || !web3.eth.sendSignedTransaction)
      web3.setProvider(new Web3.providers.HttpProvider(url));

    // --- broadcast ---
    const receiptP = new Promise((resolve, reject) => {
      web3.eth.sendSignedTransaction(signed.rawTransaction)
        .on("transactionHash", (hash) =>
          addLog({ type: "info", msg: "TX sent", hash })
        )
        .on("receipt", (rc) => resolve(rc))
        .on("error", (err) => reject(err));
    });

    const rc = await receiptP;
    addLog({
      type: rc.status ? "ok" : "err",
      msg: "TX confirmed",
      hash: rc.transactionHash,
    });
    check.click();
  } catch (e) {
    addLog({ type: "err", msg: "Send error: " + (e.message || e) });
  }
};

<!doctype html>
<html lang="ja" class="h-full bg-[#0b0b10] text-zinc-100">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>micro-bssc-wallet (EVM, Phantom style)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --ph-purple:#6d28d9;   /* phantom寄りの紫 */
      --ph-indigo:#4f46e5;
      --surface:#111217;
      --surface-2:#0f1015;
      --stroke:rgba(255,255,255,.06);
    }
    .card{ @apply rounded-2xl p-5 shadow-xl ring-1; background:linear-gradient(180deg,#0f1016, #0b0b10 70%); box-shadow:0 10px 30px rgba(0,0,0,.35); border-color:var(--stroke) }
    .primary{
      background-image:linear-gradient(135deg,var(--ph-purple),var(--ph-indigo));
      @apply text-white font-semibold rounded-xl px-4 py-2 shadow ring-1 ring-white/10 transition
             hover:brightness-110 active:scale-[.98] focus:outline-none focus-visible:ring-2 focus-visible:ring-violet-400;
    }
    .ghost{
      @apply rounded-xl px-4 py-2 bg-white/5 text-zinc-100 ring-1 ring-white/10 hover:bg-white/10 transition
             active:scale-[.98] focus:outline-none focus-visible:ring-2 focus-visible:ring-violet-400;
    }
    .field{ @apply w-full rounded-xl px-3 py-2 outline-none transition ring-1; background:#0f1117; color:#e5e7eb; border-color:var(--stroke) }
    .field::placeholder{ @apply text-zinc-500 }
    .chip{ @apply inline-flex items-center gap-2 rounded-full px-3 py-1 text-sm ring-1; background:#fff; color:#0b0b10; border-color:#e5e7eb }
    .mono{ font-variant-numeric:tabular-nums }
    .pill{ @apply inline-flex items-center gap-2 rounded-full px-3 py-1 text-sm }
    .pill.ok{ background:rgba(34,197,94,.12); color:#86efac; border:1px solid rgba(34,197,94,.25)}
    .pill.err{ background:rgba(244,63,94,.12); color:#fca5a5; border:1px solid rgba(244,63,94,.25)}
    .pill.slow{ background:rgba(245,158,11,.12); color:#fbbf24; border:1px solid rgba(245,158,11,.25)}
    .divider{ height:1px; background:linear-gradient(90deg,transparent,#ffffff12,transparent) }
    /* ログ行 */
    .log-row{ @apply grid grid-cols-[110px_minmax(0,1fr)_auto] items-center gap-3 px-3 py-2 rounded-lg ring-1; background:#0f1017; border-color:var(--stroke) }
    .tag{ @apply text-[11px] px-2 py-0.5 rounded-full font-medium }
    .tag.info{ background:#312e81; color:#c7d2fe }
    .tag.ok{ background:#064e3b; color:#a7f3d0 }
    .tag.err{ background:#7f1d1d; color:#fecaca }
    .hover-copy{ @apply cursor-pointer hover:underline decoration-dotted }
    /* トースト */
    .toast{ position:fixed; right:18px; top:18px; z-index:50; display:none; }
    .toast.show{ display:block; animation:fadein .15s ease-out }
    @keyframes fadein{ from{opacity:0; transform:translateY(-6px)} to{opacity:1; transform:none} }
  </style>
</head>
<body class="h-full">
<main class="max-w-5xl mx-auto px-4 py-8 space-y-6">
  <!-- ヘッダー -->
  <header class="flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="size-9 rounded-xl ring-1 ring-white/10"
           style="background:radial-gradient(110% 110% at top left,rgba(109,40,217,.8),rgba(79,70,229,.8)); box-shadow:0 6px 30px rgba(109,40,217,.35)"></div>
      <h1 class="text-xl md:text-2xl font-semibold tracking-tight">micro-bssc-wallet</h1>
      <span class="chip">EVM / BNB on BSSC</span>
    </div>
    <div id="status" class="pill ok hidden"><span class="size-2 rounded-full bg-emerald-400"></span><span>HEALTHY</span></div>
  </header>

  <!-- ネットワーク / 残高 -->
  <section class="grid md:grid-cols-3 gap-4">
    <div class="card space-y-3 md:col-span-2">
      <div class="text-xs uppercase text-zinc-400 tracking-wider">Network</div>
      <div class="flex gap-2">
        <input id="rpc" class="field" placeholder="https://bssc-rpc.bssc.live"/>
        <button id="ping" class="ghost">Ping</button>
      </div>
      <div class="divider my-2"></div>
      <div class="grid grid-cols-3 gap-4">
        <div>
          <div class="text-xs uppercase text-zinc-400 tracking-wider">Balance</div>
          <div id="bal" class="text-2xl font-semibold mono mt-1">—</div>
        </div>
        <div>
          <div class="text-xs uppercase text-zinc-400 tracking-wider">Gas price</div>
          <div id="gas" class="text-2xl font-semibold mono mt-1">—</div>
        </div>
        <div class="">
          <div class="text-xs uppercase text-zinc-400 tracking-wider">Last update</div>
          <div id="upd" class="mt-1 text-zinc-300">—</div>
        </div>
      </div>
    </div>

    <div class="card space-y-3">
      <div class="text-xs uppercase text-zinc-400 tracking-wider">Quick Actions</div>
      <div class="flex flex-wrap gap-2">
        <button id="gen" class="primary">Generate</button>
        <button id="save" class="ghost">Save (local)</button>
        <button id="load" class="ghost">Load</button>
        <button id="check" class="ghost">Check Balance</button>
      </div>
    </div>
  </section>

  <!-- ウォレット / 送金 -->
  <section class="grid md:grid-cols-2 gap-4">
    <div class="card space-y-3">
      <div class="text-xs uppercase text-zinc-400 tracking-wider">Your Wallet</div>
      <div class="flex items-center justify-between">
        <div class="truncate mono" id="addr">—</div>
        <div class="flex gap-2">
          <button id="copyAddr" class="ghost">Copy</button>
          <a id="expl" class="ghost" target="_blank" rel="noreferrer">Explorer</a>
        </div>
      </div>
      <div class="text-xs uppercase text-zinc-400 tracking-wider mt-2">Private Key (demo)</div>
      <textarea id="pk" rows="3" class="field"
        placeholder="※デモ用：本番は暗号化保存にしてください"></textarea>
    </div>

    <div class="card space-y-3">
      <div class="text-xs uppercase text-zinc-400 tracking-wider">Send BNB</div>
      <input id="to" class="field" placeholder="Recipient (0x… または bsscアドレス)"/>
      <div class="flex gap-2">
        <input id="amt" class="field" placeholder="Amount (BNB)"/>
        <button id="send" class="primary">Send</button>
      </div>
      <p class="text-sm text-zinc-500">* 送金には手数料が必要です（testnet BNB）。</p>
    </div>
  </section>

  <!-- ログ（Phantom風） -->
  <section class="card space-y-3">
    <div class="flex items-center justify-between">
      <div class="text-xs uppercase text-zinc-400 tracking-wider">Activity</div>
      <button id="clear" class="ghost">Clear</button>
    </div>
    <div id="logs" class="space-y-2"></div>
  </section>
</main>

<!-- トースト -->
<div id="toast" class="toast">
  <div class="rounded-xl px-3 py-2 bg-white text-black shadow-lg ring-1 ring-black/10 flex items-center gap-2">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 9v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="#10b981" stroke-width="2" stroke-linecap="round"/></svg>
    <span id="toastText" class="text-sm font-medium">Copied</span>
  </div>
</div>

<!-- ethers.js + アプリ本体 -->
<script src="https://cdn.jsdelivr.net/npm/web3@4.7.0/dist/web3.min.js"></script>
<script>
  const $  = (id)=>document.getElementById(id);
  const rpc = $("rpc"); const addr=$("addr"); const pk=$("pk");
  const gen=$("gen"); const save=$("save"); const load=$("load");
  const ping=$("ping"); const check=$("check");
  const bal=$("bal"); const gas=$("gas"); const upd=$("upd");
  const to=$("to"); const amt=$("amt"); const send=$("send");
  const logs=$("logs"); const expl=$("expl"); const copyAddr=$("copyAddr");
  const LS_KEY="micro_bssc_wallet_priv";

  let web3;       // Web3インスタンス (HTTP)
  let account;    // { address, privateKey }

  function log(type,msg){ // Phantom風ログ簡易
    const row=document.createElement("div");
    row.className="log-row";
    row.innerHTML = `<div class="mono text-zinc-400">${new Date().toLocaleTimeString()}</div>
      <div class="truncate"><span class="tag ${type==='ok'?'ok':type==='err'?'err':'info'}">${type.toUpperCase()}</span>
      <span class="ml-2">${msg}</span></div><div></div>`;
    logs.prepend(row);
  }

  function ensureWeb3(){
    const url = (rpc.value||"").trim();
    if(!url) throw new Error("RPC URLを入力");
    web3 = new Web3(new Web3.providers.HttpProvider(url));
    return web3;
  }

  // 1) ウォレット生成/保存/読込（EVM）
  gen.onclick = ()=>{
    const w = Web3.eth.accounts.create();     // {address, privateKey}
    account = w;
    addr.textContent = w.address;
    pk.value = w.privateKey;                  // 本番は暗号化保存
    expl.href = "https://explorer.bssc.live/address/"+w.address;
    log("info","新しいウォレットを生成しました");
  };
  save.onclick = ()=>{ if(!account) return log("err","先に生成");
    localStorage.setItem(LS_KEY, account.privateKey); log("ok","ローカル保存（デモ）");
  };
  load.onclick = ()=>{
    const priv = localStorage.getItem(LS_KEY);
    if(!priv) return log("err","保存がありません");
    try{
      account = Web3.eth.accounts.privateKeyToAccount(priv);
      addr.textContent = account.address; pk.value = priv;
      expl.href = "https://explorer.bssc.live/address/"+account.address;
      log("ok","ローカルから復元しました");
    }catch(e){ log("err","復元エラー: "+(e.message||e)); }
  };
  copyAddr.onclick = async ()=>{ const a=addr.textContent.trim(); if(a&&a!=="—"){ await navigator.clipboard.writeText(a); log("ok","Address copied"); } };

  // 2) Ping（生の eth_* を叩く）
  ping.onclick = async ()=>{
    try{
      ensureWeb3();
      const t0 = performance.now();
      const bnHex  = await web3.eth.call({})    // ダミー防止: 何もしない
      const block  = await web3.eth.getBlockNumber();         // eth_blockNumber
      const gasWei = await web3.eth.getGasPrice();            // eth_gasPrice
      const ms = Math.round(performance.now() - t0);
      gas.textContent = (Number(gasWei)/1e9).toFixed(3) + " gwei";
      upd.textContent = new Date().toLocaleTimeString();
      log("info",`Ping OK (block ${block}, ${ms}ms)`);
    }catch(e){ log("err","Ping失敗: "+(e.message||e)); }
  };

  // 3) 残高
  check.onclick = async ()=>{
    try{
      ensureWeb3();
      if(!account) return log("err","先にウォレットを生成/復元してください");
      const wei = await web3.eth.getBalance(account.address); // eth_getBalance
      bal.textContent = (Number(wei)/1e18) + " BNB";
      upd.textContent = new Date().toLocaleTimeString();
      log("info",`残高 ${wei} wei`);
    }catch(e){ log("err","残高取得エラー: "+(e.message||e)); }
  };

  // 4) 送金（自分で署名して送信）
  send.onclick = async ()=>{
    try{
      ensureWeb3();
      if(!account) return log("err","先にウォレットを生成/復元してください");
      const toAddr = to.value.trim(); const amount = amt.value.trim();
      if(!web3.utils.isAddress(toAddr)) return log("err","送金先が不正です");
      if(!amount) return log("err","金額を入力してください");

      const nonce = await web3.eth.getTransactionCount(account.address, "latest");
      const gasPrice = await web3.eth.getGasPrice();
      const tx = {
        from:  account.address,
        to:    toAddr,
        value: web3.utils.toWei(amount, "ether"),
        gas:   21000,                    // ネイティブ送金の基本
        gasPrice,
        nonce,
        chainId: 0x4253                 // BSSC Testnet (HEX)
      };

      const signed = await web3.eth.accounts.signTransaction(tx, account.privateKey);
      const sent   = await web3.eth.sendSignedTransaction(signed.rawTransaction);
      log("info", `送金送信: ${sent.transactionHash}`);
      log(sent.status ? "ok" : "err", `送金完了: ${sent.transactionHash}`);
      check.click();
    }catch(e){ log("err","送金エラー: "+(e.message||e)); }
  };

  // 既定RPC
  rpc.value = "https://bssc-rpc.bssc.live";
</script>
</body>
</html>

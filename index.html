<!doctype html>
<html lang="en" class="h-full bg-[#0b0b10] text-zinc-100">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>micro-bssc-wallet — Phantom style (Solana/BSSC)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --ph-purple:#6d28d9; --ph-indigo:#4f46e5; --stroke:rgba(255,255,255,.06); }
    .shell{ max-width:1100px; margin:0 auto; padding:32px 16px }
    .card{ background:linear-gradient(180deg,#10111a,#0b0b10 65%);
           border-radius:16px; padding:20px; box-shadow:0 12px 32px rgba(0,0,0,.4);
           border:1px solid var(--stroke) }
    .primary{ background-image:linear-gradient(135deg,var(--ph-purple),var(--ph-indigo));
              color:#fff; border-radius:12px; padding:10px 16px; font-weight:700;
              box-shadow:0 8px 24px rgba(109,40,217,.35); border:1px solid rgba(255,255,255,.1);
              transition:.12s ease }
    .primary:hover{ filter:brightness(1.12); transform:translateY(-1px) }
    .primary:active{ transform:translateY(0) scale(.98) }
    .ghost{ background:#ffffff0f; color:#e5e7eb; border-radius:12px; padding:10px 16px;
            border:1px solid rgba(255,255,255,.1); transition:.12s ease }
    .ghost:hover{ background:#ffffff1c } .ghost:active{ transform:scale(.98) }
    .field{ width:100%; background:#0f1117; color:#e5e7eb; border:1px solid var(--stroke);
            border-radius:12px; padding:10px 12px; outline:none }
    .field::placeholder{ color:#9ca3af }
    .mono{ font-variant-numeric:tabular-nums }
    .divider{ height:1px; background:linear-gradient(90deg,transparent,#ffffff12,transparent); margin:10px 0 }
    .pill{ display:inline-flex; align-items:center; gap:8px; border-radius:9999px; padding:6px 12px; font-weight:600 }
    .pill.ok{  background:rgba(34,197,94,.12); color:#86efac; border:1px solid rgba(34,197,94,.28) }
    .pill.err{ background:rgba(244,63,94,.12); color:#fca5a5; border:1px solid rgba(244,63,94,.28) }
    .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:9999px;
           background:#fff; color:#0b0b10; border:1px solid #e5e7eb; font-weight:600 }
    .log-row{ display:grid; grid-template-columns:110px minmax(0,1fr) auto; align-items:center; gap:12px;
              padding:10px 12px; border-radius:12px; background:#10111a; border:1px solid var(--stroke) }
    .tag{ font-size:11px; padding:2px 8px; border-radius:9999px; font-weight:700 }
    .tag.info{ background:#2a2e6b; color:#c7d2fe } .tag.ok{ background:#0a3c2f; color:#a7f3d0 }
    .tag.err{ background:#5f1b1b; color:#fecaca } .hover-copy{ cursor:pointer; text-decoration:underline; text-decoration-style:dotted }
    #logs{ min-height: 120px; }
  </style>
</head>
<body>
  <main class="shell space-y-6">
    <!-- Header -->
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl ring-1 ring-white/10"
          style="background:radial-gradient(110% 110% at top left,rgba(109,40,217,.9),rgba(79,70,229,.9)); box-shadow:0 6px 26px rgba(109,40,217,.4)"></div>
        <h1 class="text-xl md:text-2xl font-semibold tracking-tight">micro-bssc-wallet</h1>
        <span class="chip">Solana runtime / BSSC token</span>
      </div>
      <div id="status" class="pill ok" style="display:none">
        <span class="w-2 h-2 rounded-full bg-emerald-400"></span><span>HEALTHY</span>
      </div>
    </header>

    <!-- Network / Quick -->
    <section class="grid md:grid-cols-3 gap-4">
      <div class="card md:col-span-2">
        <div class="text-xs uppercase text-zinc-400 mb-2">Network</div>
        <div class="flex flex-wrap gap-2">
          <input id="rpc" class="field" placeholder="https://bssc-rpc.bssc.live/"/>
          <button id="ping" class="ghost">Ping</button>
          <a class="ghost" target="_blank" rel="noreferrer" href="https://bssc.live/#faucet">Get Test BSSC</a>
        </div>
        <div class="divider"></div>
        <div class="grid grid-cols-3 gap-4">
          <div><div class="text-xs uppercase text-zinc-400">Balance</div><div id="bal" class="text-2xl font-semibold mono mt-1">—</div></div>
          <div><div class="text-xs uppercase text-zinc-400">Fee (lamports)</div><div id="fee" class="text-2xl font-semibold mono mt-1">—</div></div>
          <div><div class="text-xs uppercase text-zinc-400">Last update</div><div id="upd" class="mt-1 text-zinc-300">—</div></div>
        </div>
      </div>

      <div class="card space-y-3">
        <div class="text-xs uppercase text-zinc-400">Quick Actions</div>
        <div class="flex flex-wrap gap-2">
          <button id="gen"        class="primary">Generate Wallet</button>
          <button id="importRaw"  class="ghost">Recover Wallet</button>
          <button id="check"      class="ghost">Check Balance</button>
        </div>
      </div>
    </section>

    <!-- Wallet / Send -->
    <section class="grid md:grid-cols-2 gap-4">
      <div class="card space-y-3">
        <div class="text-xs uppercase text-zinc-400">Your Wallet</div>
        <div class="flex items-center justify-between">
          <div id="addr" class="truncate mono">—</div>
          <div class="flex gap-2">
            <button id="copyAddr" class="ghost">Copy</button>
          </div>
        </div>
        <div class="text-xs uppercase text-zinc-400 mt-2">Secret (base64)</div>
        <div class="flex gap-2">
          <textarea id="sec" rows="3" class="field flex-1" placeholder="Demo only: 64-byte base64 secret key"></textarea>
          <button id="copySec" class="ghost">Copy</button>
        </div>
      </div>

      <div class="card space-y-3">
        <div class="text-xs uppercase text-zinc-400">Send BSSC (Base58 address)</div>
        <input id="to" class="field" placeholder="Recipient (Base58)"/>
        <div class="flex gap-2">
          <input id="amt" class="field" placeholder="Amount (BSSC)"/>
          <button id="max"  class="ghost">Max</button>
          <button id="send" class="primary">Send</button>
        </div>
        <p class="text-sm text-zinc-500">1 BSSC = 1,000,000,000 lamports</p>
      </div>
    </section>

    <!-- Activity -->
    <section class="card space-y-3">
      <div class="flex items-center justify-between">
        <div class="text-xs uppercase text-zinc-400">Activity</div>
        <button id="clear" class="ghost">Clear</button>
      </div>
      <div id="logs" class="space-y-2"></div>
    </section>
  </main>

  <!-- Solana web3.js (ESM) -->
  <script type="module">
    import {
      Connection, Keypair, PublicKey,
      SystemProgram, Transaction, sendAndConfirmTransaction,
      LAMPORTS_PER_SOL, Message
    } from "https://esm.sh/@solana/web3.js@1.95.3?bundle";

    // ---------- DOM ----------
    const $ = (id)=>document.getElementById(id);
    const rpc=$("rpc"), ping=$("ping"), check=$("check");
    const gen=$("gen"), importRaw=$("importRaw");
    const addr=$("addr"), sec=$("sec"), copyAddr=$("copyAddr"), copySec=$("copySec");
    const balEl=$("bal"), feeEl=$("fee"), upd=$("upd");
    const toEl=$("to"), amtEl=$("amt"), maxBtn=$("max"), sendBtn=$("send");
    const logs=$("logs"), clearBtn=$("clear"), status=$("status");

    // ---------- State ----------
    const EXPL="https://explorer.bssc.live";
    const DEFAULT_RPC="https://bssc-rpc.bssc.live/"; // direct RPC as requested
    let conn=null, wallet=null, feeHint=5000;

    // ---------- Utils ----------
    const b64e=(u8)=>btoa(String.fromCharCode(...u8));
    const b64d=(b)=>Uint8Array.from(atob(b), c=>c.charCodeAt(0));
    const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));

    function addLog({type="info", msg, sig}){
      const box = document.getElementById("logs"); if(!box) return;
      const row=document.createElement("div"); row.className="log-row";
      const ts=document.createElement("div"); ts.className="mono text-zinc-400"; ts.textContent=new Date().toLocaleTimeString();
      const body=document.createElement("div"); body.className="truncate";
      const tag=document.createElement("span"); tag.className=`tag ${type==="ok"?"ok":type==="err"?"err":"info"}`; tag.textContent=type.toUpperCase();
      body.appendChild(tag);
      if (sig) {
        const a=document.createElement("a");
        a.href=`${EXPL}/tx/${sig}`; a.target="_blank"; a.rel="noreferrer";
        a.textContent = " " + sig.slice(0,10)+"…"+sig.slice(-8); a.className="hover-copy";
        body.appendChild(a);
      } else {
        const span=document.createElement("span"); span.className="ml-2"; span.textContent=msg; body.appendChild(span);
      }
      row.appendChild(ts); row.appendChild(body);
      box.prepend(row);
      try{ box.parentElement?.scrollIntoView({behavior:"smooth", block:"nearest"});}catch{}
    }

    function ensureConn(){
      const url=(rpc.value||"").trim() || DEFAULT_RPC;
      conn = new Connection(url, "confirmed");
      return conn;
    }

    async function getLatestBH(){
      const { blockhash, lastValidBlockHeight } = await conn.getLatestBlockhash("confirmed");
      return { blockhash, lastValidBlockHeight };
    }

    // ---------- Actions ----------
    gen.addEventListener("click", ()=>{
      wallet = Keypair.generate();
      addr.textContent = wallet.publicKey.toBase58();
      sec.value = b64e(wallet.secretKey);
      addLog({msg:"Generated new wallet"});
    });

    importRaw.addEventListener("click", ()=>{
      const raw = prompt("Paste base64 secret key (64 bytes)"); if(!raw) return;
      try{
        wallet = Keypair.fromSecretKey(b64d(raw.trim()));
        addr.textContent = wallet.publicKey.toBase58();
        sec.value = raw.trim();
        addLog({type:"ok", msg:"Recovered wallet from base64 secret"});
      }catch(e){ addLog({type:"err", msg:"Recover failed: "+(e.message||e)}); }
    });

    copyAddr.addEventListener("click", async ()=>{
      const a=addr.textContent.trim(); if(!a || a==="—") return;
      await navigator.clipboard.writeText(a); addLog({type:"ok", msg:"Address copied"});
    });
    copySec.addEventListener("click", async ()=>{
      const s=sec.value.trim(); if(!s) return;
      await navigator.clipboard.writeText(s); addLog({type:"ok", msg:"Secret (base64) copied"});
    });

    ping.addEventListener("click", async ()=>{
      try{
        ensureConn();
        const t0=performance.now();
        const slot = await conn.getSlot("confirmed");
        const ms = Math.round(performance.now()-t0);
        feeEl.textContent = feeHint.toLocaleString();
        upd.textContent = new Date().toLocaleTimeString();
        status.style.display="inline-flex"; status.className="pill ok";
        addLog({msg:`Ping OK (slot ${slot}, ${ms}ms)`});
      }catch(e){
        status.style.display="inline-flex"; status.className="pill err";
        addLog({type:"err", msg:"Ping failed: "+(e.message||e)});
      }
    });

    check.addEventListener("click", async ()=>{
      try{
        ensureConn(); if(!wallet) return addLog({type:"err", msg:"Generate first"});
        const lamports = await conn.getBalance(wallet.publicKey,"confirmed");
        balEl.textContent = (lamports / LAMPORTS_PER_SOL) + " BSSC";
        upd.textContent = new Date().toLocaleTimeString();
        addLog({msg:`Balance ${lamports} lamports`});
      }catch(e){ addLog({type:"err", msg:"Balance error: "+(e.message||e)}); }
    });

    maxBtn.addEventListener("click", async ()=>{
      try{
        ensureConn(); if(!wallet) return addLog({type:"err", msg:"Generate first"});
        const lamports = await conn.getBalance(wallet.publicKey,"confirmed");
        const sendable = Math.max(0, lamports - feeHint);
        amtEl.value = (sendable / LAMPORTS_PER_SOL).toString();
        addLog({msg:`Max computed (fee ≈ ${feeHint} lamports)`});
      }catch(e){ addLog({type:"err", msg:"Max error: "+(e.message||e)}); }
    });

    // sendRawTransaction(base64) → fallback(sendTransaction) → confirm
    sendBtn.addEventListener("click", async ()=>{
      try{
        ensureConn();
        if(!wallet) return addLog({type:"err", msg:"Generate first"});
        const to = (toEl.value||"").trim();
        const amount = Number(amtEl.value||"0");
        if(!to || !amount) return addLog({type:"err", msg:"Enter recipient & amount"});

        let toPk; try{ toPk = new PublicKey(to); }catch{ return addLog({type:"err", msg:"Recipient must be Base58 (Solana)"}); }

        sendBtn.disabled = true; sendBtn.textContent = "Sending…";

        const lamports = Math.round(amount * LAMPORTS_PER_SOL);
        const { blockhash, lastValidBlockHeight } = await getLatestBH();
        const tx = new Transaction({ recentBlockhash:blockhash, feePayer:wallet.publicKey })
          .add(SystemProgram.transfer({ fromPubkey: wallet.publicKey, toPubkey: toPk, lamports }));

        // fee/balance pre-check（概算）
        const bal = await conn.getBalance(wallet.publicKey,"confirmed");
        if (bal < lamports + feeHint) {
          const need = ((lamports+feeHint - bal)/LAMPORTS_PER_SOL).toFixed(9);
          sendBtn.disabled=false; sendBtn.textContent="Send";
          return addLog({type:"err", msg:`Insufficient funds (+${need} BSSC incl. fee)`});
        }

        // sign → base64
        tx.sign(wallet);
        const raw = tx.serialize();
        const b64 = btoa(String.fromCharCode(...raw));

        // 送信（raw優先）
        let sig;
        try {
          const r = await fetch(DEFAULT_RPC, {
            method:"POST", headers:{ "content-type":"application/json" },
            body: JSON.stringify({ jsonrpc:"2.0", id:Date.now(), method:"sendRawTransaction",
              params:[b64, { skipPreflight:false, maxRetries:3 }] })
          });
          const j = await r.json();
          if (j.error) throw new Error(j.error.message || "sendRawTransaction failed");
          sig = j.result;
        } catch(e) {
          // fallback: sendTransaction(encoding:base64)
          const r2 = await fetch(DEFAULT_RPC, {
            method:"POST", headers:{ "content-type":"application/json" },
            body: JSON.stringify({ jsonrpc:"2.0", id:Date.now(), method:"sendTransaction",
              params:[b64, { skipPreflight:false, maxRetries:3, encoding:"base64" }] })
          });
          const j2 = await r2.json();
          if (j2.error) throw new Error(j2.error.message || "sendTransaction failed");
          sig = j2.result;
        }

        // Activity に即出す
        addLog({type:"info", msg:"TX sent", sig});

        // confirm（強め）
        await conn.confirmTransaction({ signature:sig, blockhash, lastValidBlockHeight }, "confirmed");
        addLog({type:"ok", msg:"TX confirmed", sig});
        check.click();

      } catch(e){
        // 例外に署名が含まれているときはリンク化
        const m = (e.message||"").match(/[1-9A-Za-z]{87,}/);
        if (m) addLog({type:"err", msg:"Confirm error (see explorer)", sig:m[0]});
        else   addLog({type:"err", msg:"Send error: "+(e.message||e)});
      } finally {
        sendBtn.disabled=false; sendBtn.textContent="Send";
      }
    });

    clearBtn.addEventListener("click", ()=>{ logs.innerHTML=""; });

    // default network
    rpc.value = DEFAULT_RPC;
  </script>
</body>
</html>
